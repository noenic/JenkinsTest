pipeline {
    agent none
    environment {
        DISCORD_WEBHOOK = credentials('discord_webhook')
        VERSION = ''
    }
    stages {
        stage('Test on Worker') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    echo "Étape 0 : Installation des dépendances"
                    sh 'pip3 install -r requirements.txt'
                }
                script {
                    echo "Étape 1 : Lire la version depuis le fichier"
                    VERSION = sh(script: 'cat ./src/version', returnStdout: true).trim()
                    echo "La version du fichier est : ${VERSION}"
                }
                script {
                    echo "Étape 2 : Lancer le serveur Flask main.py"
                    sh 'python3 src/main.py &'
                    // Attendre un peu pour que le serveur démarre 
                    sleep time: 5, unit: 'SECONDS'
                }
                script {
                    echo "Étape 3 : Exécuter les tests de l'application (test.py)"
                    sh 'python3 src/test.py'
                    sh 'pkill -f main.py'
                }
            }
        }
        stage('Build and Test Docker Image') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    echo "Étape 5 : Build du Dockerfile avec la version taguée"
                    sh "docker build -t reg.noenic.duckdns.org/pythonapi:${VERSION} ."
                }

                script {
                    echo "Étape 6 : test de l'image"
                    sh "docker run -d -p 5000:5000 reg.noenic.duckdns.org/pythonapi:${VERSION}"
                    sleep time: 5, unit: 'SECONDS'
                }
                script {
                    echo "Étape 7 : Tester l'endpoint /version"
                    if(sh(script: 'curl localhost:5000/version', returnStdout: true).trim() != VERSION) {
                        error "Test de l'endpoint /version échoué"
                    }
                    sh 'docker stop $(docker ps -a -q)'
                    sh 'docker rm $(docker ps -a -q)'
                }
            }
        }
        stage('Push Docker Image') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    sh "docker push reg.noenic.duckdns.org/pythonapi:${VERSION}"
                }
            }
        }
        stage('Deploy to cluster') {
            agent {
                label 'master'
            }
            steps {
                script {
                    echo "Étape 1 : Déploiement de l'application sur le cluster"
                    sh "helm upgrade --install pythonapi ./Chart --set image.tag=${env.VERSION} -n tp"
                    sleep time: 10, unit: 'SECONDS'
                }
                script{
                    echo "Étape 2 : Test de l'application déployée"
                    if (sh(script: "curl -s http://192.168.0.250:30809/version", returnStdout: true).trim() != VERSION) {
                        error "Test de l'endpoint /version échoué"
                    }
                }
            }
        }
    }
}
