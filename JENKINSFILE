pipeline {
    agent none

    stages {
        stage('Test on Worker') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    // Étape 0 : Installation des dépendances
                    sh 'pip3 install -r requirements.txt'

                    try {
                        // Étape 1 : Lancer le serveur Flask main.py
                        sh 'python3 src/main.py &'
                        
                        // Attendre un peu pour que le serveur démarre (ajuster si nécessaire)
                        sleep time: 5, unit: 'SECONDS'
                        
                        // Étape 2 : Exécuter les tests de l'application (test.py)
                        sh 'python3 src/test.py'
                        
                        // Étape 3 : Arrêter le serveur Flask
                        sh 'pkill -f main.py'
                        
                        // Étape 4 : Lire la version depuis le fichier
                        def versionFileContent = sh(script: 'cat ./src/version', returnStdout: true).trim()
                        env.VERSION = versionFileContent

                        echo "La version du fichier est : ${env.VERSION}"
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'  // Marquer le build comme échoué
                        error('Échec d\'une étape, arrêt du pipeline.')  // Arrêter le pipeline
                    }
                }
            }
        }

        stage('Build and Push on Worker') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    // Étape 5 : Build du Dockerfile avec la version taguée
                    try {
                        sh "docker build -t reg.noenic.duckdns.org/pythonapi:${env.VERSION} ."
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'  // Marquer le build comme échoué
                        error('Échec d\'une étape, arrêt du pipeline.')  // Arrêter le pipeline
                    }
                }
            }
            post {
                success {
                    // Étape 6 : Push de l'image taguée sur DockerHub
                    script {
                        sh "docker push reg.noenic.duckdns.org/pythonapi:${env.VERSION}"
                    }
                }
                failure {
                    error('Les tests ont échoué, arrêt du pipeline.')
                }
            }
        }

        stage('Deploy Helm Chart on Master') {
            agent {
                label 'master'
            }
            steps {
                script {
                    sh "helm upgrade --install pythonapi ./Chart --set image.tag=${env.VERSION}"
                }
            }
        }
    }
}
