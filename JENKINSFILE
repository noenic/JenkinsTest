pipeline {
    agent none
    environment {
        DISCORD_WEBHOOK = credentials('discord_webhook')
    }
    stages {
        stage('Test on Worker') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    env.CURRENT_STEP = "Install dependencies"
                    echo "Étape 0 : Installation des dépendances"
                    sh 'pip3 install -r requirements.txt'
                }
                script {
                    env.CURRENT_STEP = "Get version from file"
                    echo "Étape 1 : Lire la version depuis le fichier"
                    VERSION = sh(script: 'cat ./src/version', returnStdout: true).trim()
                    echo "La version du fichier est : ${VERSION}"
                }
                script {
                    env.CURRENT_STEP = "Run Flask server"
                    echo "Étape 2 : Lancer le serveur Flask main.py"
                    sh 'python3 src/main.py &'
                    // Attendre un peu pour que le serveur démarre 
                    sleep time: 5, unit: 'SECONDS'
                }
                script {
                    env.CURRENT_STEP = "Run tests"
                    echo "Étape 3 : Exécuter les tests de l'application (test.py)"
                    sh 'python3 src/test.py'
                    sh 'pkill -f python3'
                }
            }
        }
        stage('Build and Test Docker Image') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    env.CURRENT_STEP = "build docker image"
                    echo "Étape 5 : Build du Dockerfile avec la version taguée"
                    sh "docker build -t reg.noenic.duckdns.org/pythonapi:${VERSION} ."
                }
                script {
                    env.CURRENT_STEP = "test docker image"
                    echo "Étape 6 : test de l'image"
                    sh "docker rm -f pythonapi || true"
                    sh "docker run -d -p 5000:5000 --name pythonapi --rm reg.noenic.duckdns.org/pythonapi:${VERSION}"
                    sleep time: 5, unit: 'SECONDS'
                    echo "Étape 7 : Tester l'endpoint /version"
                    if(sh(script: 'curl -s 172.17.0.1:5000/version', returnStdout: true).trim() != VERSION) {
                        error "Test de l'endpoint /version échoué"
                    }
                    sh "docker rm -f pythonapi"
                }
            }
        }
        stage('Push Docker Image') {
            agent {
                label 'worker'
            }
            steps {
                script {
                    env.CURRENT_STEP = "push docker image"
                    sh "docker push reg.noenic.duckdns.org/pythonapi:${VERSION}"
                }
            }
        }
        stage('Deploy to cluster') {
            agent {
                label 'master'
            }
            steps {
                script {
                    env.CURRENT_STEP = "get version from file (helm-side)"
                    echo "Étape 0 : Récupération de la version"
                    VERSION = sh(script: 'cat ./src/version', returnStdout: true).trim()
                }
                script {
                    env.CURRENT_STEP = "deploy to cluster"
                    echo "Étape 1 : Déploiement de l'application sur le cluster"
                    sh "helm upgrade --install pythonapi ./Chart --set image.tag=${VERSION} -n tp"
                    sleep time: 10, unit: 'SECONDS'
                }
                script {
                    env.CURRENT_STEP = "test deployed application"
                    echo "Étape 2 : Test de l'application déployée"
                    if (sh(script: "curl -s http://192.168.0.250:30809/version", returnStdout: true).trim() != VERSION) {
                        error "Test de l'endpoint /version échoué"
                    }
                }
            }
        }
    }
    post {
        always{
            agent {
                label 'master'
            }
            discordSend(
                        title: "Projet PythonAPI",
                        description: currentBuild.currentResult == 'SUCCESS' ? "Le déploiement de l'application est un succès." : "Le déploiement de l'application est un échec. \n\n ${currentBuild.currentResult}",
                        footer: "Build ${currentBuild.number}",
                        link: env.BUILD_URL,
                        result: currentBuild.currentResult,
                        webhookURL: DISCORD_WEBHOOK
             )
        }
    }
}
